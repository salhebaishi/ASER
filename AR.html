<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desert Odyssey AR Chemistry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tone.js is loaded globally -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.142.0/build/three.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
            color: white;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; /* Allow clicks to pass through to the canvas */
        }
        .overlay > * {
             pointer-events: auto; /* Re-enable pointer events for UI elements */
        }
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid #4b5563;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #374151;
            border-radius: 9999px;
            height: 0.75rem;
        }
        .progress-bar {
            background: linear-gradient(to right, #34d399, #10b981);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .quiz-option {
            transition: background-color: 0.2s;
        }
        .quiz-option:hover {
            background-color: #4b5563;
        }
        #badge-toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #6d28d9;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            z-index: 100;
            transition: opacity 0.5s, transform 0.5s;
        }
        .object-label {
            position: absolute;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            transform: translateX(-50%) translateY(-120%); /* Position above the object center */
            display: none; /* Hidden by default */
            pointer-events: none;
            text-transform: capitalize;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="ar-container" class="hidden">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- Object Labels -->
    <div id="label-draggable" class="object-label"></div>
    <div id="label-target" class="object-label"></div>
    <div id="label-wrong" class="object-label"></div>
    
    <div id="ui-overlay" class="overlay hidden">
        <!-- Top UI: Progress, Level, and Title -->
        <div class="top-ui">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Desert Odyssey AR</h1>
                    <p class="text-sm text-gray-300">An ASER Framework Experience</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-lg">Level <span id="level-display">1</span></p>
                    <div id="badges-container" class="flex justify-end space-x-1 mt-1"></div>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-sm font-semibold mb-1">Adventure Progress</p>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Bottom UI: Story and Interaction -->
        <div class="bottom-ui">
            <div id="story-box" class="bg-black/60 p-4 rounded-lg backdrop-blur-sm border border-gray-600">
                <h2 id="story-title" class="text-lg font-bold text-emerald-300"></h2>
                <p id="story-text" class="mt-2 text-gray-200"></p>
            </div>
            <button id="action-button" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Start Challenge
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="start-modal" class="modal-bg">
        <div class="modal-content text-center">
            <h1 class="text-3xl font-bold mb-4 text-emerald-400">Welcome to Desert Odyssey</h1>
            <p class="text-gray-300 mb-6">You'll help Lina succeed using chemistry. This experience requires camera access to overlay 3D models on your world.</p>
            
            <!-- Music Upload Button -->
            <button id="upload-music-button" class="w-full mb-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                Load Custom Music
            </button>
            <input type="file" id="music-file-input" accept="audio/mpeg" class="hidden">
            <p id="music-file-name" class="text-sm text-gray-400 mb-4 truncate">Default Music Loaded</p>
            
            <p id="permission-error-message" class="text-sm text-red-400 mb-4"></p>

            <button id="start-button" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Start AR
            </button>
        </div>
    </div>

    <div id="quiz-modal" class="modal-bg hidden">
        <div class="modal-content">
            <h2 id="quiz-question" class="text-xl font-bold mb-6"></h2>
            <div id="quiz-options" class="space-y-3"></div>
            <div id="feedback-box" class="mt-4 p-3 rounded-lg hidden">
                <p id="feedback-text" class="font-semibold"></p>
            </div>
        </div>
    </div>
    
    <div id="badge-toast" class="hidden"></div>


    <script>
        // --- Global State and Managers ---
        let currentStep = 0;
        let mixer, scene, camera, renderer;
        const clock = new THREE.Clock();
        
        // Interaction State
        let draggableObject = null;
        let wrongDraggableObject = null;
        let targetObject = null;
        let currentlyDraggedObject = null;
        let isDragging = false;
        const initialPositions = new Map();
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // Gamification State
        let level = 1;
        let badges = [];
        let mistakeMadeOnCurrentQuestion = false;
        
        // Music State
        let customMusicUrl = null;

        // --- ASER: Emotional Memory (Sound Manager) ---
        const soundManager = {
            synth: null,
            backgroundMusic: null,
            isInitialized: false,

            async initialize() {
                console.log("Initializing Sound Manager...");
                await window.Tone.start();
                this.synth = new window.Tone.PolySynth(window.Tone.Synth, {
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                }).toDestination();
                
                if (customMusicUrl) {
                    this.backgroundMusic = new window.Tone.Player({
                        url: customMusicUrl,
                        loop: true,
                        volume: -10,
                    }).toDestination();
                    await window.Tone.loaded();
                } 
                else {
                    this.backgroundMusic = new window.Tone.Sequence((time, note) => {
                        const melodySynth = new window.Tone.Synth().toDestination();
                        melodySynth.triggerAttackRelease(note, 0.5, time);
                    }, ["C4", "E4", "G4", "C5", "E5", "G4", "E4", "C4"], "4n");
                    window.Tone.Transport.bpm.value = 80;
                }
                
                this.isInitialized = true;
                console.log("Sound Manager Initialized.");
            },
            
            startBackgroundMusic() {
                if (!this.isInitialized || !this.backgroundMusic) {
                    console.error("Background music not ready.");
                    return;
                }
                
                if (this.backgroundMusic instanceof window.Tone.Player) {
                    if (this.backgroundMusic.loaded) {
                        this.backgroundMusic.start();
                        console.log("Custom background music started.");
                    }
                } else {
                    this.backgroundMusic.start(0);
                    window.Tone.Transport.start();
                    console.log("Default procedural music started.");
                }
            },

            playSuccess() { if (!this.isInitialized) return; this.synth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); },
            playEncouragement() { if (!this.isInitialized) return; this.synth.triggerAttackRelease("A3", "8n"); },
            playInteraction() { if (!this.isInitialized) return; this.synth.triggerAttackRelease("C3", "8n"); }
        };

        // --- Story and Content Data (Expanded to cover all slides) ---
        const storyData = [
            { title: "Clean Dirty Water (Disinfect)", text: "Lina finds murky water. Add the correct powder to disinfect it.", actionText: "Prepare to Purify", interactionType: 'drag', models: { draggable: 'purification_powder', target: 'murky_water', wrongDraggable: 'sugar_pile' }, reaction: "2KMnOâ‚„ + Hâ‚‚O â†’ 2KOH + 2MnOâ‚‚ + 3Oâ‚‚" },
            { title: "My Knife Is Turning Orange!", text: "Lina sees rust on her knife. Use the correct item to clean it.", actionText: "Prepare to Clean", interactionType: 'drag', models: { draggable: 'lemon_half', target: 'knife', wrongDraggable: 'catalyst_pouch' }, reaction: "Feâ‚‚Oâ‚ƒ + 6Hâº â†’ 2FeÂ³âº + 3Hâ‚‚O" },
            { title: "Lemon Battery!", text: "Lina needs light. Insert the correct components into the lemon to create a current.", actionText: "Prepare Battery", interactionType: 'drag', models: { draggable: 'electrodes', target: 'lemon_battery_body', wrongDraggable: 'purification_powder' }, reaction: "Zn + CuÂ²âº â†’ ZnÂ²âº + Cu" },
            { title: "Foam Fountain Signal!", text: "Create a large visual signal by adding the catalyst to the hydrogen peroxide.", actionText: "Prepare Foam Signal", interactionType: 'drag', models: { draggable: 'catalyst_pouch', target: 'peroxide_beaker', wrongDraggable: 'lemon_half' }, reaction: "2Hâ‚‚Oâ‚‚ â†’ 2Hâ‚‚O + Oâ‚‚(g)" },
            { title: "Smoke to Ask for Help", text: "A smoke signal is crucial. Combine the correct powders.", actionText: "Prepare Smoke Signal", interactionType: 'drag', models: { draggable: 'sugar_pile', target: 'kno3_pile', wrongDraggable: 'catalyst_pouch' }, reaction: "Câ‚â‚‚Hâ‚‚â‚‚Oâ‚â‚ + KNOâ‚ƒ â†’ COâ‚‚ + Hâ‚‚O + Nâ‚‚ + Kâ‚‚COâ‚ƒ" },
            { title: "Warm at Night", text: "Lina is cold. She can activate a heat pack for warmth.", actionText: "Activate Heat Pack", interactionType: 'tap', models: { target: 'heat_pack' }, reaction: "4Fe + 3Oâ‚‚ â†’ 2Feâ‚‚Oâ‚ƒ (Exothermic)" },
            { title: "Inflating a Balloon Signal", text: "Another signal idea: inflate a balloon with a chemical reaction.", actionText: "Prepare Inflation", interactionType: 'drag', models: { draggable: 'baking_soda', target: 'vinegar_bottle', wrongDraggable: 'sugar_pile'}, reaction: "NaHCOâ‚ƒ + HCâ‚‚Hâ‚ƒOâ‚‚ â†’ NaCâ‚‚Hâ‚ƒOâ‚‚ + Hâ‚‚O + COâ‚‚"},
            { title: "Clean Dirty Water (Filter)", text: "This water is full of dirt. Lina can build a filter to clean it.", actionText: "Prepare Filter", interactionType: 'drag', models: { draggable: 'dirty_water_cup', target: 'sand_filter', wrongDraggable: 'lemon_half' }, reaction: "Physical Filtration"},
            { title: "Testing Water pH", text: "Is this new water source safe? Lina can test if it's acidic or basic using cabbage juice.", actionText: "Prepare pH Test", interactionType: 'drag', models: { draggable: 'cabbage_dropper', target: 'water_sample', wrongDraggable: 'catalyst_pouch' }, reaction: "Anthocyanin Indicator"},
            { title: "Hot Cup From White Powder", text: "Lina needs to heat something without fire. She can add water to this powder.", actionText: "Prepare Reaction", interactionType: 'drag', models: { draggable: 'water_cup', target: 'cao_powder', wrongDraggable: 'sugar_pile'}, reaction: "CaO + Hâ‚‚O â†’ Ca(OH)â‚‚ (Exothermic)"},
            { title: "Ice Without a Fridge", text: "Lina needs to cool something down. She just needs to activate the cold pack.", actionText: "Activate Cold Pack", interactionType: 'tap', models: { target: 'cold_pack' }, reaction: "NHâ‚„NOâ‚ƒ(s) + Hâ‚‚O(l) â†’ NHâ‚„NOâ‚ƒ(aq) (Endothermic)" },
            { title: "Super Bright Fire", text: "For a powerful flare, she just needs to ignite the magnesium strip.", actionText: "Ignite Magnesium Strip", interactionType: 'tap', models: { target: 'magnesium' }, reaction: "2Mg + Oâ‚‚ â†’ 2MgO + Light" },
            { title: "Final Challenge: The Quiz", text: "Lina has used chemistry to master the elements. Now, test your knowledge.", actionText: "Start the Quiz", models: null }
        ];
        
        const quizData = [
            { question: "What does Potassium Permanganate (KMnOâ‚„) do to dirty water?", options: ["Makes it salty", "Cools it down", "Disinfects it", "Makes it fizzy"], answer: "Disinfects it" },
            { question: "A heat pack getting warm is an example of an ___ reaction.", options: ["Exothermic", "Endothermic", "Acidic", "Neutral"], answer: "Exothermic" },
            { question: "What gas inflates the balloon when vinegar and baking soda mix?", options: ["Oxygen (Oâ‚‚)", "Hydrogen (Hâ‚‚)", "Carbon Dioxide (COâ‚‚)", "Nitrogen (Nâ‚‚)"], answer: "Carbon Dioxide (COâ‚‚)"},
            { question: "Cabbage juice turns what color in an acidic solution?", options: ["Blue/Green", "Purple", "Red/Pink", "Yellow"], answer: "Red/Pink"},
            { question: "The reaction in a cold pack is...", options: ["Exothermic (releases heat)", "Endothermic (absorbs heat)", "Combustion", "Neutral"], answer: "Endothermic (absorbs heat)" },
            { question: "In the lemon battery, what flows to create electricity?", options: ["Protons", "Neutrons", "Electrons", "Water"], answer: "Electrons" },
        ];

        // --- ASER: Gamification (Game Manager) ---
        const gameManager = {
            levelDisplay: document.getElementById('level-display'),
            progressBar: document.getElementById('progress-bar'),
            quizModal: document.getElementById('quiz-modal'),
            quizQuestion: document.getElementById('quiz-question'),
            quizOptions: document.getElementById('quiz-options'),
            feedbackBox: document.getElementById('feedback-box'),
            feedbackText: document.getElementById('feedback-text'),
            levelUp() { level++; this.levelDisplay.textContent = level; soundManager.playSuccess(); },
            awardBadge(badgeName) { if (badges.includes(badgeName)) return; badges.push(badgeName); const badgeElement = document.createElement('span'); badgeElement.textContent = 'ðŸ†'; badgeElement.title = badgeName; document.getElementById('badges-container').appendChild(badgeElement); const toast = document.getElementById('badge-toast'); toast.textContent = `Badge Unlocked: ${badgeName}!`; toast.classList.remove('hidden'); setTimeout(() => { toast.style.opacity = 1; toast.style.transform = 'translateX(-50%) translateY(0)'; }, 10); setTimeout(() => { toast.style.opacity = 0; toast.style.transform = 'translateX(-50%) translateY(20px)'; setTimeout(() => toast.classList.add('hidden'), 500); }, 3000); },
            updateProgress(step) { const progress = (step / (storyData.length - 1)) * 100; this.progressBar.style.width = `${progress}%`; },
            startQuiz() { this.currentQuizQuestion = 0; this.quizModal.classList.remove('hidden'); this.showQuizQuestion(); },
            showQuizQuestion() { mistakeMadeOnCurrentQuestion = false; this.feedbackBox.classList.add('hidden'); const q = quizData[this.currentQuizQuestion]; this.quizQuestion.textContent = q.question; this.quizOptions.innerHTML = ''; q.options.forEach(option => { const button = document.createElement('button'); button.textContent = option; button.className = "w-full text-left p-4 bg-gray-700 rounded-lg quiz-option"; button.onclick = () => this.checkAnswer(option); this.quizOptions.appendChild(button); }); },
            checkAnswer(selectedOption) { const correctAnwer = quizData[this.currentQuizQuestion].answer; this.feedbackBox.classList.remove('hidden'); if (selectedOption === correctAnwer) { soundManager.playSuccess(); this.feedbackText.textContent = "Correct! Well done."; this.feedbackBox.className = "mt-4 p-3 rounded-lg bg-green-800 text-green-200"; if (mistakeMadeOnCurrentQuestion) { this.awardBadge("Comeback Kid"); } setTimeout(() => { this.currentQuizQuestion++; if (this.currentQuizQuestion < quizData.length) { this.showQuizQuestion(); } else { this.endQuiz(); } }, 1500); } else { soundManager.playEncouragement(); mistakeMadeOnCurrentQuestion = true; this.feedbackText.textContent = "That's a great guess! Chemistry can be tricky. Give it another shot!"; this.feedbackBox.className = "mt-4 p-3 rounded-lg bg-yellow-800 text-yellow-200"; } },
            endQuiz() { this.quizModal.classList.add('hidden'); storyManager.showFinalMessage(); this.levelUp(); }
        };

        // --- ASER: Interactive Storytelling (Story Manager) ---
        const storyManager = {
            storyTitle: document.getElementById('story-title'),
            storyText: document.getElementById('story-text'),
            actionButton: document.getElementById('action-button'),

            updateStep(stepIndex) {
                const step = storyData[stepIndex];
                this.storyTitle.textContent = step.title;
                this.storyText.innerHTML = `${step.text}<br/><br/><small class='text-gray-400'>Reaction: ${step.reaction || ''}</small>`;
                this.actionButton.textContent = step.actionText;
                this.actionButton.onclick = step.models ? () => this.startChallenge(step) : () => gameManager.startQuiz();
            },

            startChallenge(step) {
                // NEW: Robust cleanup routine at the beginning of every challenge.
                if (draggableObject) scene.remove(draggableObject);
                if (wrongDraggableObject) scene.remove(wrongDraggableObject);
                if (targetObject) scene.remove(targetObject);
                draggableObject = null;
                wrongDraggableObject = null;
                targetObject = null;
                arManager.hideAllLabels();

                initialPositions.clear();
                soundManager.playInteraction();
                arManager.loadStepModels(step, (models) => {
                    draggableObject = models.draggable;
                    wrongDraggableObject = models.wrongDraggable;
                    targetObject = models.target;
                    
                    if (draggableObject) {
                        initialPositions.set(draggableObject, draggableObject.position.clone());
                        scene.add(draggableObject);
                    }
                    if (wrongDraggableObject) {
                        initialPositions.set(wrongDraggableObject, wrongDraggableObject.position.clone());
                        scene.add(wrongDraggableObject);
                    }
                    scene.add(targetObject);

                    if (step.interactionType === 'drag') {
                        this.storyText.textContent = `Drag the correct item onto the ${targetObject.userData.name}.`;
                    } else {
                        this.storyText.textContent = "Tap on the object to perform the chemical reaction.";
                    }
                    this.actionButton.classList.add('hidden');
                });
            },

            showIncorrectDragFeedback() {
                soundManager.playEncouragement();
                const originalText = this.storyText.textContent;
                this.storyText.textContent = "That's not the right combination. The properties don't match for this reaction.";
                setTimeout(() => this.storyText.textContent = originalText, 2500);
            },
            
            completeChallenge() {
                const objectToAnimate = targetObject;
                if (!objectToAnimate || !objectToAnimate.animationClip) return;
                
                arManager.hideAllLabels();
                if (draggableObject) scene.remove(draggableObject);
                if (wrongDraggableObject) scene.remove(wrongDraggableObject);
                draggableObject = null;
                wrongDraggableObject = null;

                const clip = objectToAnimate.animationClip;
                mixer = new THREE.AnimationMixer(objectToAnimate);
                const action = mixer.clipAction(clip);
                action.reset(); action.setLoop(THREE.LoopOnce); action.clampWhenFinished = true; action.play();
                
                let finished = false;
                const onFinish = () => {
                    if (finished) return;
                    finished = true;
                    scene.remove(targetObject);
                    targetObject = null;
                    mixer = null; 
                    currentStep++;
                    gameManager.updateProgress(currentStep); 
                    gameManager.levelUp();
                    storyManager.updateStep(currentStep);
                    storyManager.actionButton.classList.remove('hidden');
                };
                mixer.addEventListener('finished', onFinish);
                setTimeout(onFinish, (clip.duration + 0.2) * 1000);
            },
            
            showFinalMessage() {
                this.storyTitle.textContent = "Congratulations!";
                this.storyText.textContent = "You have successfully applied your chemistry knowledge to help Lina succeed and have completed the ASER framework demonstration.";
                this.actionButton.textContent = "Restart Journey";
                this.actionButton.onclick = () => window.location.reload();
            }
        };

        // --- AR and 3D Rendering Manager ---
        const arManager = {
            async init() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                const canvas = document.getElementById('canvas');
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                const light = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(light);
                const pointLight = new THREE.PointLight(0xffffff, 0.8);
                camera.add(pointLight);
                scene.add(camera);

                const video = document.getElementById('video');
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    await video.play();
                } else { throw new Error("getUserMedia not supported"); }
                
                document.getElementById('ar-container').classList.remove('hidden');
                
                document.body.addEventListener('mousedown', onInteractionStart, false);
                document.body.addEventListener('mousemove', onInteractionMove, false);
                document.body.addEventListener('mouseup', onInteractionEnd, false);
                document.body.addEventListener('touchstart', onInteractionStart, false);
                document.body.addEventListener('touchmove', onInteractionMove, false);
                document.body.addEventListener('touchend', onInteractionEnd, false);

                renderer.setAnimationLoop(() => {
                    const delta = clock.getDelta();
                    if (mixer) mixer.update(delta);

                    if(draggableObject) {
                        if(draggableObject.userData.isRotating) draggableObject.rotation.y += 0.005;
                        this.updateLabel(draggableObject, document.getElementById('label-draggable'));
                    }
                    if(wrongDraggableObject) {
                        if(wrongDraggableObject.userData.isRotating) wrongDraggableObject.rotation.y += 0.005;
                         this.updateLabel(wrongDraggableObject, document.getElementById('label-wrong'));
                    }
                    if(targetObject) {
                        if(targetObject.userData.isRotating) targetObject.rotation.y += 0.005;
                        this.updateLabel(targetObject, document.getElementById('label-target'));
                    }

                    renderer.render(scene, camera);
                });
                
                document.getElementById('ui-overlay').classList.remove('hidden');
                storyManager.updateStep(currentStep);
                gameManager.updateProgress(currentStep);
            },

            updateLabel(object, labelElement) {
                if (!object || !labelElement) return;
                labelElement.textContent = object.userData.name;
                const vector = new THREE.Vector3();
                object.getWorldPosition(vector);
                vector.project(camera);

                const x = (vector.x * .5 + .5) * renderer.domElement.clientWidth;
                const y = (vector.y * -.5 + .5) * renderer.domElement.clientHeight;

                labelElement.style.display = 'block';
                labelElement.style.left = `${x}px`;
                labelElement.style.top = `${y}px`;
            },

            hideAllLabels() {
                document.getElementById('label-draggable').style.display = 'none';
                document.getElementById('label-target').style.display = 'none';
                document.getElementById('label-wrong').style.display = 'none';
            },

            loadStepModels(step, callback) {
                const models = { draggable: null, wrongDraggable: null, target: null };
                const zPos = -4.5;
                
                if (step.models.draggable) {
                    models.draggable = this.createModel(step.models.draggable);
                    models.draggable.position.set(-2.5, 0.2, zPos);
                }
                 if (step.models.wrongDraggable) {
                    models.wrongDraggable = this.createModel(step.models.wrongDraggable);
                    models.wrongDraggable.position.set(0, -0.2, zPos);
                }
                models.target = this.createModel(step.models.target);
                models.target.position.set(step.interactionType === 'drag' ? 2.5 : 0, 0.2, zPos);
                models.target.animationClip = this.createAnimationForTarget(step.models.target, models.target);

                callback(models);
            },

            createModel(type) {
                let geometry, material;
                const model = new THREE.Group();
                model.userData.name = type.replace(/_/g, ' ');
                model.userData.isRotating = true;

                switch (type) {
                    // --- Draggables ---
                    case 'purification_powder': geometry = new THREE.BoxGeometry(0.4, 0.6, 0.2); material = new THREE.MeshStandardMaterial({ color: 0x800080 }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'lemon_half': geometry = new THREE.SphereGeometry(0.4, 32, 32, 0, Math.PI); material = new THREE.MeshStandardMaterial({ color: 0xFFFF00 }); const l = new THREE.Mesh(geometry, material); l.rotation.z = Math.PI / 2; model.add(l); break;
                    case 'electrodes': const cG = new THREE.CylinderGeometry(0.2, 0.2, 0.04, 16); const cM = new THREE.MeshStandardMaterial({ color: 0xB87333 }); const c=new THREE.Mesh(cG,cM); c.position.y=0.2; model.add(c); const nG = new THREE.CylinderGeometry(0.05, 0.05, 0.6, 8); const nM=new THREE.MeshStandardMaterial({color:0xD3D3D3}); const n=new THREE.Mesh(nG,nM); n.position.y=-0.2; model.add(n); break;
                    case 'catalyst_pouch': geometry = new THREE.BoxGeometry(0.4, 0.4, 0.1); material = new THREE.MeshStandardMaterial({ color: 0xD2B48C }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'sugar_pile': geometry = new THREE.ConeGeometry(0.4, 0.5, 32); material = new THREE.MeshStandardMaterial({ color: 0xFFFFFF }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'baking_soda': geometry = new THREE.BoxGeometry(0.4, 0.6, 0.2); material = new THREE.MeshStandardMaterial({ color: 0xF0EAD6 }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'dirty_water_cup': geometry = new THREE.CylinderGeometry(0.3, 0.3, 0.6, 32); material = new THREE.MeshStandardMaterial({ color: 0x6B4F35, transparent:true, opacity:0.8 }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'cabbage_dropper': geometry = new THREE.CylinderGeometry(0.05, 0.05, 0.8, 16); material = new THREE.MeshStandardMaterial({ color: 0x4B0082 }); model.add(new THREE.Mesh(geometry, material)); break;
                    case 'water_cup': geometry = new THREE.CylinderGeometry(0.3, 0.3, 0.6, 32); material = new THREE.MeshStandardMaterial({ color: 0xADD8E6, transparent:true, opacity:0.5 }); model.add(new THREE.Mesh(geometry, material)); break;

                    // --- Targets ---
                    case 'murky_water': geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32); material = new THREE.MeshStandardMaterial({ color: 0x6B4F35, transparent: true, opacity: 0.7 }); const w = new THREE.Mesh(geometry, material); w.name = "water_mesh"; model.add(w); break;
                    case 'knife': geometry = new THREE.BoxGeometry(0.2, 2, 0.05); material = new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.8 }); const k = new THREE.Mesh(geometry, material); k.name = "blade_mesh"; model.add(k); break;
                    case 'lemon_battery_body': geometry = new THREE.SphereGeometry(0.5, 32, 32); material = new THREE.MeshStandardMaterial({ color: 0xFFFF00 }); const lb = new THREE.Mesh(geometry, material); lb.scale.set(1, 1.2, 1); lb.name="lemon_mesh"; model.add(lb); const s = new THREE.Mesh(new THREE.SphereGeometry(0.1, 8, 8), new THREE.MeshBasicMaterial({color:0xFFFFFF, transparent:true, opacity:0})); s.name="spark_mesh"; s.position.y=0.5; model.add(s); break;
                    case 'peroxide_beaker': geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32); material = new THREE.MeshStandardMaterial({ color: 0xADD8E6, transparent: true, opacity: 0.5 }); model.add(new THREE.Mesh(geometry, material)); const fG = new THREE.CylinderGeometry(0.45, 0.45, 0.1, 32); const fM = new THREE.MeshStandardMaterial({color:0xFFFFFF}); const f = new THREE.Mesh(fG,fM); f.name="foam_mesh"; f.position.y=-0.4; model.add(f); break;
                    case 'kno3_pile': geometry = new THREE.ConeGeometry(0.5, 0.4, 32); material = new THREE.MeshStandardMaterial({ color: 0x964B00 }); model.add(new THREE.Mesh(geometry, material)); const smG = new THREE.CylinderGeometry(0.1, 1, 0.1, 32); const smM = new THREE.MeshStandardMaterial({color:0x888888, transparent:true, opacity:0}); const sm=new THREE.Mesh(smG,smM); sm.name="smoke_mesh"; model.add(sm); break;
                    case 'vinegar_bottle': geometry = new THREE.CylinderGeometry(0.4, 0.4, 1.2, 32); material = new THREE.MeshStandardMaterial({color: 0xF5F5DC, transparent: true, opacity: 0.6}); model.add(new THREE.Mesh(geometry, material)); const balG = new THREE.SphereGeometry(0.2, 32, 32); const balM = new THREE.MeshStandardMaterial({color:0xFF4136, opacity:0.8}); const bal = new THREE.Mesh(balG, balM); bal.name="balloon_mesh"; bal.position.y=0.7; model.add(bal); break;
                    case 'sand_filter': const filG = new THREE.CylinderGeometry(0.2, 0.6, 1.5, 32); const filM = new THREE.MeshStandardMaterial({color: 0x888888, transparent:true, opacity:0.3}); model.add(new THREE.Mesh(filG, filM)); const cleanG = new THREE.CylinderGeometry(0.18, 0.58, 0.1, 32); const cleanM = new THREE.MeshStandardMaterial({color:0xADD8E6, transparent:true, opacity:0}); const cleanW = new THREE.Mesh(cleanG, cleanM); cleanW.name="clean_water_mesh"; cleanW.position.y = -0.7; model.add(cleanW); break;
                    case 'water_sample': geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32); material = new THREE.MeshStandardMaterial({ color: 0xADD8E6, transparent: true, opacity: 0.5 }); const ws = new THREE.Mesh(geometry, material); ws.name="sample_mesh"; model.add(ws); break;
                    case 'cao_powder': geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32); material = new THREE.MeshStandardMaterial({ color: 0xF5F5F5 }); const cao = new THREE.Mesh(geometry, material); cao.name = "cao_mesh"; model.add(cao); break;
                    
                    // --- Tap Models ---
                    case 'cold_pack': geometry = new THREE.BoxGeometry(1, 1, 0.2); material = new THREE.MeshStandardMaterial({ color: 0x4169E1, transparent: true }); const p = new THREE.Mesh(geometry, material); p.name="pack_mesh"; model.add(p); break;
                    case 'heat_pack': geometry = new THREE.BoxGeometry(1, 1, 0.2); material = new THREE.MeshStandardMaterial({ color: 0xB22222, transparent: true }); const hp = new THREE.Mesh(geometry, material); hp.name="heat_pack_mesh"; model.add(hp); break;
                    case 'magnesium': geometry = new THREE.BoxGeometry(1, 0.1, 0.02); material = new THREE.MeshStandardMaterial({ color: 0xeeeeee, emissive: 0x000000 }); const m = new THREE.Mesh(geometry, material); m.name = "strip_mesh"; model.add(m); break;
                }
                return model;
            },

            createAnimationForTarget(type, targetModel) {
                switch(type) {
                    case 'murky_water': const w = targetModel.getObjectByName("water_mesh"); const c = new THREE.Color(0xADD8E6); return new THREE.AnimationClip('anim', 2, [new THREE.ColorKeyframeTrack(`${w.name}.material.color`, [0, 1.5], [w.material.color.r, w.material.color.g, w.material.color.b, c.r, c.g, c.b])]);
                    case 'knife': const k = targetModel.getObjectByName("blade_mesh"); const cc = new THREE.Color(0xC0C0C0); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${k.name}.material.color`, [0, 1], [k.material.color.r, k.material.color.g, k.material.color.b, cc.r, cc.g, cc.b])]);
                    case 'lemon_battery_body': const s = targetModel.getObjectByName("spark_mesh"); return new THREE.AnimationClip('anim', 1.5, [new THREE.NumberKeyframeTrack(`${s.name}.material.opacity`, [0, 0.2, 0.4, 1], [0, 1, 1, 0])]);
                    case 'peroxide_beaker': const f = targetModel.getObjectByName("foam_mesh"); return new THREE.AnimationClip('anim', 2, [new THREE.VectorKeyframeTrack(`${f.name}.scale`, [0, 1.5], [1,1,1, 1,20,1]), new THREE.VectorKeyframeTrack(`${f.name}.position`, [0, 1.5], [0,-0.4,0, 0,0.5,0])]);
                    case 'kno3_pile': const sm = targetModel.getObjectByName("smoke_mesh"); return new THREE.AnimationClip('anim', 2.5, [new THREE.VectorKeyframeTrack(`${sm.name}.scale`, [0, 2], [1,1,1, 1,30,1]), new THREE.VectorKeyframeTrack(`${sm.name}.position`, [0, 2], [0,0,0, 0,1.5,0]), new THREE.NumberKeyframeTrack(`${sm.name}.material.opacity`, [0, 0.5, 2], [0, 0.6, 0])]);
                    case 'cold_pack': const p = targetModel.getObjectByName("pack_mesh"); const fc = new THREE.Color(0xFFFFFF); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${p.name}.material.color`, [0, 1], [p.material.color.r, p.material.color.g, p.material.color.b, fc.r, fc.g, fc.b]), new THREE.NumberKeyframeTrack(`${p.name}.material.opacity`, [0, 1], [1, 0.8])]);
                    case 'heat_pack': const hp = targetModel.getObjectByName("heat_pack_mesh"); const hc = new THREE.Color(0xFF8C00); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${hp.name}.material.color`, [0, 1], [hp.material.color.r, hp.material.color.g, hp.material.color.b, hc.r, hc.g, hc.b])]);
                    case 'magnesium': const m = targetModel.getObjectByName("strip_mesh"); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${m.name}.material.emissive`, [0, 0.2, 0.4, 1], [0,0,0, 1,1,1, 1,1,1, 0,0,0])]);
                    case 'vinegar_bottle': const bal = targetModel.getObjectByName("balloon_mesh"); return new THREE.AnimationClip('anim', 2, [new THREE.VectorKeyframeTrack(`${bal.name}.scale`, [0, 1.5], [1,1,1, 5,5,5])]);
                    case 'sand_filter': const cleanW = targetModel.getObjectByName("clean_water_mesh"); return new THREE.AnimationClip('anim', 2, [new THREE.NumberKeyframeTrack(`${cleanW.name}.material.opacity`, [0, 1.5], [0, 0.7])]);
                    case 'water_sample': const ws = targetModel.getObjectByName("sample_mesh"); const rc = new THREE.Color(0xFF4500); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${ws.name}.material.color`, [0, 1], [ws.material.color.r, ws.material.color.g, ws.material.color.b, rc.r, rc.g, rc.b])]);
                    case 'cao_powder': const cao = targetModel.getObjectByName("cao_mesh"); const hot = new THREE.Color(0xFF4500); return new THREE.AnimationClip('anim', 1.5, [new THREE.ColorKeyframeTrack(`${cao.name}.material.emissive`, [0, 0.5, 1], [0,0,0, hot.r, hot.g, hot.b, 0,0,0])]);
                    default: return null;
                }
            }
        };

        // --- Interaction Handlers ---
        function onInteractionStart(event) {
            if (event.target.id.includes('button') || event.target.closest('.modal-content')) return;
            const eventCoord = event.changedTouches ? event.changedTouches[0] : event;
            mouse.x = (eventCoord.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(eventCoord.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            let draggedFound = false;
            if (draggableObject) {
                const intersects = raycaster.intersectObject(draggableObject, true);
                if (intersects.length > 0) {
                    isDragging = true;
                    currentlyDraggedObject = draggableObject;
                    draggedFound = true;
                }
            }
            if (!draggedFound && wrongDraggableObject) {
                 const intersects = raycaster.intersectObject(wrongDraggableObject, true);
                if (intersects.length > 0) {
                    isDragging = true;
                    currentlyDraggedObject = wrongDraggableObject;
                }
            }
            
            if (isDragging) {
                 currentlyDraggedObject.userData.isRotating = false; 
            } else if (targetObject) { // Handle tap interactions
                const intersects = raycaster.intersectObject(targetObject, true);
                if (intersects.length > 0 && storyData[currentStep].interactionType === 'tap') {
                    storyManager.completeChallenge();
                }
            }
        }

        function onInteractionMove(event) {
            if (!isDragging || !currentlyDraggedObject) return;
            const eventCoord = event.changedTouches ? event.changedTouches[0] : event;
            mouse.x = (eventCoord.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(eventCoord.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const plane = new THREE.Plane();
            plane.setFromNormalAndCoplanarPoint(camera.getWorldDirection(plane.normal), currentlyDraggedObject.position);
            const intersectionPoint = new THREE.Vector3();
            raycaster.ray.intersectPlane(plane, intersectionPoint);
            currentlyDraggedObject.position.copy(intersectionPoint);
        }

        function onInteractionEnd(event) {
            if (!isDragging || !currentlyDraggedObject) { isDragging = false; return; }
            isDragging = false;
            currentlyDraggedObject.userData.isRotating = true;
            
            if (targetObject && currentlyDraggedObject.position.distanceTo(targetObject.position) < 1.5) { 
                if (currentlyDraggedObject === draggableObject) {
                    storyManager.completeChallenge();
                } else {
                    storyManager.showIncorrectDragFeedback();
                    currentlyDraggedObject.position.copy(initialPositions.get(currentlyDraggedObject));
                }
            } else {
                currentlyDraggedObject.position.copy(initialPositions.get(currentlyDraggedObject));
            }
            currentlyDraggedObject = null;
        }

        // --- App Initialization ---
        document.getElementById('upload-music-button').addEventListener('click', () => {
            document.getElementById('music-file-input').click();
        });

        document.getElementById('music-file-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type === "audio/mpeg") {
                customMusicUrl = URL.createObjectURL(file);
                document.getElementById('music-file-name').textContent = file.name;
                console.log("Custom music file loaded:", file.name);
            }
        });

        document.getElementById('start-button').addEventListener('click', async () => {
            const startButton = document.getElementById('start-button');
            const errorMessage = document.getElementById('permission-error-message');
            
            startButton.disabled = true;
            startButton.textContent = "Starting...";
            errorMessage.textContent = "";

            try {
                // Initialize the sound manager and wait for the music file to fully load
                await soundManager.initialize();
                
                // Now that the music is loaded and we are still in the user's "click" context,
                // we can safely start the music.
                soundManager.startBackgroundMusic();
                
                // Proceed to initialize the AR camera and the rest of the app
                await arManager.init();
                
                document.getElementById('start-modal').classList.add('hidden');

            } catch (err) {
                console.error("Error starting the app:", err);
                errorMessage.textContent = "Camera access denied. Please check your browser/system settings and try again.";
                startButton.disabled = false;
                startButton.textContent = "Start AR";
            }
        });
    </script>
</body>
</html>

