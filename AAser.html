<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desert Odyssey AR Chemistry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.142.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Inter', sans-serif; touch-action: none; }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; color: white; background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.8) 100%); pointer-events: none; }
        .overlay > * { pointer-events: auto; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; border: 1px solid #4b5563; }
        .progress-bar-container { width: 100%; background-color: #374151; border-radius: 9999px; height: 0.75rem; }
        .progress-bar { background: linear-gradient(to right, #34d399, #10b981); height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }
        #badge-toast { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background-color: #6d28d9; color: white; padding: 1rem 1.5rem; border-radius: 9999px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 100; transition: opacity 0.5s, transform 0.5s; }
        .object-label { position: absolute; color: white; background: rgba(0, 0, 0, 0.6); padding: 4px 8px; border-radius: 4px; font-size: 14px; text-align: center; transform: translateX(-50%) translateY(-120%); display: none; pointer-events: none; text-transform: capitalize; }
        .backpack-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 1rem; max-height: 40vh; overflow-y: auto; margin-top: 1rem; }
        .backpack-item { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.5rem; text-align: center; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .backpack-item:hover { background-color: #4b5563; transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="ar-container" class="hidden">
        <video id="video" playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="label-draggable" class="object-label"></div>
    <div id="label-target" class="object-label"></div>
    
    <div id="ui-overlay" class="overlay hidden">
        <div class="top-ui">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Desert Odyssey AR</h1>
                    <p class="text-sm text-gray-300">An ASER Framework Experience</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-lg">Level <span id="level-display">1</span></p>
                    <div id="badges-container" class="flex justify-end space-x-1 mt-1"></div>
                </div>
            </div>
            <div class="mt-4">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="bottom-ui">
            <div id="story-box" class="bg-black/60 p-4 rounded-lg backdrop-blur-sm border border-gray-600">
                <h2 id="story-title" class="text-lg font-bold text-emerald-300"></h2>
                <p id="story-text" class="mt-2 text-gray-200"></p>
            </div>
            <div class="flex space-x-2 mt-4">
                <button id="backpack-button" class="w-1/3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hidden">Open Backpack</button>
                <button id="action-button" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Start Challenge</button>
            </div>
        </div>
    </div>

    <div id="start-modal" class="modal-bg">
        <div class="modal-content text-center">
            <h1 class="text-3xl font-bold mb-4 text-emerald-400">Welcome to Desert Odyssey</h1>
            <input type="text" id="name-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 mb-4" placeholder="Enter your name...">
            <button id="start-button" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Start Experience</button>
            <p id="permission-error-message" class="text-sm text-yellow-400 mt-4"></p>
        </div>
    </div>

    <div id="quiz-modal" class="modal-bg hidden">
        <div class="modal-content">
            <h2 id="quiz-question" class="text-xl font-bold mb-6"></h2>
            <div id="quiz-options" class="space-y-3"></div>
        </div>
    </div>

    <div id="backpack-modal" class="modal-bg hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-center">Chemist's Backpack</h2>
            <p id="backpack-prompt" class="text-center text-gray-300 text-sm mt-1"></p>
            <div id="backpack-grid" class="backpack-grid"></div>
            <button id="close-backpack-button" class="mt-4 w-full bg-red-500 py-2 rounded-lg">Close</button>
        </div>
    </div>
    
    <div id="badge-toast" class="hidden"></div>

    <script>
        let currentStep = 0;
        let mixer, scene, camera, renderer;
        const clock = new THREE.Clock();
        let characterName = "Survivor";
        let draggableObject = null, targetObject = null, currentlyDraggedObject = null;
        let isDragging = false;
        const initialPositions = new Map();
        let level = 1, badges = [], inventory = ['aluminum_foil', 'baking_soda', 'cabbage_dropper', 'catalyst_pouch', 'dirty_water_cup', 'drain_cleaner', 'electrodes', 'heat_source', 'lemon_half', 'purification_powder', 'sugar_pile', 'water_cup'].sort();

        const handTrackingManager = {
            hands: null, latestResults: null, isPinching: false,
            initialize(videoElement) {
                this.hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                this.hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                this.hands.onResults((results) => { this.latestResults = results; this.checkPinch(); });
                new Camera(videoElement, { onFrame: async () => { await this.hands.send({ image: videoElement }); }, width: 1280, height: 720 }).start();
            },
            checkPinch() {
                this.isPinching = false;
                if (this.latestResults?.multiHandLandmarks?.[0]) {
                    const l = this.latestResults.multiHandLandmarks[0];
                    this.isPinching = Math.hypot(l[8].x - l[4].x, l[8].y - l[4].y) < 0.05;
                }
            },
            getFingerScreenPos() {
                if (this.latestResults?.multiHandLandmarks?.[0]) {
                    const i = this.latestResults.multiHandLandmarks[0][8];
                    return { x: (1 - i.x) * window.innerWidth, y: i.y * window.innerHeight };
                }
                return null;
            }
        };

        const soundManager = {
            synth: null, isInitialized: false,
            async initialize() { await window.Tone.start(); this.synth = new window.Tone.PolySynth(window.Tone.Synth).toDestination(); this.isInitialized = true; },
            playSuccess() { if(this.isInitialized) this.synth.triggerAttackRelease(["C5", "E5", "G5"], "8n"); },
            playEncouragement() { if(this.isInitialized) this.synth.triggerAttackRelease("A3", "8n"); }
        };

        const storyData = [
            { title: "No Water to Drink!", text: "{NAME} needs clean water. Use the heat source to boil the water.", actionText: "Begin Distillation", interactionType: 'drag', models: { draggable: 'heat_source', target: 'salty_water' }, reaction: "H₂O(l) + Heat ⟶ H₂O(g)" },
            { title: "Final Challenge: The Quiz", text: "Test your knowledge.", actionText: "Start the Quiz", models: null }
        ];

        const gameManager = {
            levelUp() { level++; document.getElementById('level-display').textContent = level; soundManager.playSuccess(); },
            updateProgress(step) { document.getElementById('progress-bar').style.width = `${(step / (storyData.length - 1)) * 100}%`; }
        };

        const arManager = {
            async init(isArMode = true) {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), alpha: isArMode });
                renderer.setSize(window.innerWidth, window.innerHeight);
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                if (isArMode) handTrackingManager.initialize(document.getElementById('video'));
                document.getElementById('ar-container').classList.remove('hidden');
                document.getElementById('ui-overlay').classList.remove('hidden');
                renderer.setAnimationLoop(this.renderLoop.bind(this));
                storyManager.updateStep(currentStep);
            },
            renderLoop() {
                if (mixer) mixer.update(clock.getDelta());
                this.handleHandInteraction();
                if(draggableObject) this.updateLabel(draggableObject, document.getElementById('label-draggable'));
                if(targetObject) this.updateLabel(targetObject, document.getElementById('label-target'));
                renderer.render(scene, camera);
            },
            handleHandInteraction() {
                const fingerPos = handTrackingManager.getFingerScreenPos();
                if (!fingerPos) return;
                const fingerNDC = { x: (fingerPos.x / window.innerWidth) * 2 - 1, y: -(fingerPos.y / window.innerHeight) * 2 + 1 };
                if (handTrackingManager.isPinching) {
                    if (!isDragging) {
                        const checkObjects = [draggableObject, targetObject].filter(o => o);
                        for (const obj of checkObjects) {
                            const objPos = new THREE.Vector3();
                            obj.getWorldPosition(objPos).project(camera);
                            if (Math.hypot(fingerNDC.x - objPos.x, fingerNDC.y - objPos.y) < 0.2) {
                                if (storyData[currentStep].interactionType === 'drag' && obj === draggableObject) {
                                    isDragging = true; currentlyDraggedObject = obj; return;
                                }
                            }
                        }
                    } else {
                        const vec = new THREE.Vector3(fingerNDC.x, fingerNDC.y, 0.5).unproject(camera);
                        const dir = vec.sub(camera.position).normalize();
                        currentlyDraggedObject.position.copy(camera.position.clone().add(dir.multiplyScalar(-camera.position.z / dir.z)));
                    }
                } else if (isDragging && currentlyDraggedObject) {
                    const tPos = new THREE.Vector3(), dPos = new THREE.Vector3();
                    targetObject.getWorldPosition(tPos).project(camera);
                    currentlyDraggedObject.getWorldPosition(dPos).project(camera);
                    if (Math.hypot(tPos.x - dPos.x, tPos.y - dPos.y) < 0.25) storyManager.completeChallenge();
                    else currentlyDraggedObject.position.copy(initialPositions.get(currentlyDraggedObject));
                    isDragging = false; currentlyDraggedObject = null;
                }
            },
            updateLabel(obj, el) {
                const v = new THREE.Vector3(); obj.getWorldPosition(v).project(camera);
                el.style.display = 'block'; el.textContent = obj.userData.name;
                el.style.left = `${(v.x * .5 + .5) * window.innerWidth}px`;
                el.style.top = `${(v.y * -.5 + .5) * window.innerHeight}px`;
            },
            loadStepModels(step, callback) {
                const models = { draggable: null, target: this.createModel(step.models.target) };
                models.target.position.set(step.interactionType === 'drag' ? 1.5 : 0, 0, -4);
                models.target.animationClip = this.createAnimationForTarget(models.target);
                callback(models);
            },
            createModel(type) {
                const model = new THREE.Group(); model.userData.name = type.replace(/_/g, ' '); model.scale.set(2, 2, 2);
                if (type === 'heat_source') {
                    // LOAD YOUR PNG IMAGE HERE
                    const texture = new THREE.TextureLoader().load('heat.png');
                    const material = new THREE.SpriteMaterial({ map: texture, transparent: true });
                    const sprite = new THREE.Sprite(material);
                    sprite.scale.set(0.8, 1, 1);
                    model.add(sprite);
                } else if (type === 'salty_water') {
                    const g = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                    const m = new THREE.MeshStandardMaterial({ color: 0x87aebf, transparent: true, opacity: 0.8 });
                    const mesh = new THREE.Mesh(g, m); mesh.name = "salty_water_mesh"; model.add(mesh);
                }
                return model;
            },
            createAnimationForTarget(model) {
                const mesh = model.getObjectByName('salty_water_mesh');
                if (!mesh) return null;
                const track = new THREE.ColorKeyframeTrack(`${mesh.uuid}.material.color`, [0, 1.5], [0.5,0.6,0.7, 0.6,0.9,1.0]);
                return new THREE.AnimationClip('anim', 2, [track]);
            }
        };

        const storyManager = {
            updateStep(i) {
                const s = storyData[i];
                document.getElementById('story-title').textContent = s.title.replace(/{NAME}/g, characterName);
                document.getElementById('story-text').textContent = s.text.replace(/{NAME}/g, characterName);
                document.getElementById('action-button').onclick = s.models ? () => this.startChallenge(s) : () => alert("End of Demo");
            },
            startChallenge(s) {
                if (draggableObject) scene.remove(draggableObject); if (targetObject) scene.remove(targetObject);
                arManager.loadStepModels(s, (m) => {
                    targetObject = m.target; scene.add(targetObject);
                    document.getElementById('action-button').classList.add('hidden');
                    document.getElementById('backpack-button').classList.remove('hidden');
                });
            },
            completeChallenge() {
                mixer = new THREE.AnimationMixer(targetObject);
                mixer.clipAction(targetObject.animationClip).setLoop(THREE.LoopOnce).play();
                mixer.addEventListener('finished', () => {
                    scene.remove(targetObject); scene.remove(draggableObject);
                    currentStep++; gameManager.updateProgress(currentStep); gameManager.levelUp(); this.updateStep(currentStep);
                    document.getElementById('action-button').classList.remove('hidden');
                    document.getElementById('backpack-button').classList.add('hidden');
                });
            }
        };

        const backpackManager = {
            open() {
                const grid = document.getElementById('backpack-grid'); grid.innerHTML = '';
                inventory.forEach(item => {
                    const d = document.createElement('div'); d.className = 'backpack-item'; d.textContent = item.replace(/_/g, ' ');
                    d.onclick = () => {
                        if (item === storyData[currentStep].models.draggable) {
                            if (draggableObject) scene.remove(draggableObject);
                            draggableObject = arManager.createModel(item); draggableObject.position.set(-1.5, 0.5, -4);
                            initialPositions.set(draggableObject, draggableObject.position.clone());
                            scene.add(draggableObject); document.getElementById('backpack-modal').classList.add('hidden');
                        } else soundManager.playEncouragement();
                    };
                    grid.appendChild(d);
                });
                document.getElementById('backpack-modal').classList.remove('hidden');
            }
        };

        document.getElementById('backpack-button').onclick = () => backpackManager.open();
        document.getElementById('close-backpack-button').onclick = () => document.getElementById('backpack-modal').classList.add('hidden');
        document.getElementById('start-button').onclick = async () => {
            characterName = document.getElementById('name-input').value || "Survivor";
            await soundManager.initialize(); await arManager.init(true);
            document.getElementById('start-modal').classList.add('hidden');
        };
    </script>
</body>
</html>